//
//  SettlementServiceTests.swift
//  Home PokerTests
//
//  Тесты для SettlementService - расчёт балансов и переводов
//

import Testing
import Foundation
@testable import Home_Poker

@Suite("Тесты расчёта балансов и переводов")
struct SettlementServiceTests {
    let service = SettlementService()
    
    @Test("9 игроков с банком - все сценарии")
    func ninePlayerTest() {
        /*
         ОПИСАНИЕ СЕССИИ:
         ================
         
         Домашняя игра в покер на 9 человек. Курс: 1 фишка = 1 рубль.
         
         ИГРОКИ И ИХ РЕЗУЛЬТАТЫ:
         -----------------------
         1. Алексей  - большой победитель, закупился 10000₽, вывел 23000₽ → выигрыш +13000₽
         2. Борис    - средний победитель, закупился 10000₽, вывел 17000₽ → выигрыш +7000₽
         3. Виктор   - небольшой победитель, закупился 10000₽, вывел 13000₽ → выигрыш +3000₽
         4. Григорий - небольшой победитель, закупился 10000₽, вывел 13000₽ → выигрыш +3000₽
         5. Дмитрий  - небольшой проигрыш, закупился 10000₽, вывел 8000₽ → проигрыш -2000₽
         6. Евгений  - средний проигрыш, закупился 10000₽, вывел 5000₽ → проигрыш -5000₽
         7. Жанна    - средний проигрыш, закупился 10000₽, вывел 6000₽ → проигрыш -4000₽
         8. Зинаида  - большой проигрыш, закупился 10000₽, вывел 3000₽ → проигрыш -7000₽
         9. Игорь    - большой проигрыш, закупился 10000₽, вывел 2000₽ → проигрыш -8000₽
         
         Проверка баланса: выигрыши = 13000 + 7000 + 3000 + 3000 = 26000₽
         проигрыши = 2000 + 5000 + 4000 + 7000 + 8000 = 26000₽ ✅
         
         ОПЕРАЦИИ С БАНКОМ (покрываем все сценарии):
         --------------------------------------------

         Сценарий 1: Переплата (игрок внёс больше долга, банк должен вернуть разницу)
         - Евгений внёс 7000₽ (его долг 5000₽) → переплата 2000₽ → банк вернёт 2000₽ ✅

         Сценарий 2: Частичный депозит (долг частично покрыт через банк)
         - Жанна внесла 2000₽ (её долг 4000₽) → осталось 2000₽ платить напрямую
         - Игорь внёс 5000₽ (его долг 8000₽) → осталось 3000₽ платить напрямую

         Сценарий 3: Без депозита (не вносил в банк, платит напрямую)
         - Дмитрий не вносил → платит 2000₽ напрямую
         - Зинаида не вносила → платит 7000₽ напрямую

         Сценарий 4: Без withdrawal (никто не получал напрямую из банка до расчётов)
         - Все победители получат через алгоритм распределения депозитов

         Итого в банке:
         - Внесено (депозиты): 7000 + 2000 + 5000 = 14000₽
         - Выдано (withdrawals): 0₽
         - Для распределения: 14000₽
         
         ОЖИДАЕМЫЙ РАСЧЁТ:
         -----------------
         
         Net contributions (внесено - выдано):
         - Евгений: 7000 - 0 = +7000₽
         - Жанна: 2000 - 0 = +2000₽
         - Игорь: 5000 - 0 = +5000₽
         - Все остальные: 0

         Начальные балансы (до распределения через банк):
         - Алексей: +13000₽
         - Борис: +7000₽
         - Виктор: +3000₽
         - Григорий: +3000₽
         - Дмитрий: -2000₽
         - Евгений: -5000₽
         - Жанна: -4000₽
         - Зинаида: -7000₽
         - Игорь: -8000₽

         Проверка баланса: выигрыши (+26000₽) + проигрыши (-26000₽) = 0₽ ✅
         
         РАСПРЕДЕЛЕНИЕ ДЕПОЗИТОВ ЧЕРЕЗ БАНК (жадный алгоритм):
         ------------------------------------------------------

         Активные депозиты (отсортированы по убыванию): Евгений(7000), Игорь(5000), Жанна(2000) = 14000₽
         Начальные победители: Алексей(13000), Борис(7000), Виктор(3000), Григорий(3000)

         Алгоритм (строки 120-149 SettlementService.swift):

         ШАГ 5: РАСПРЕДЕЛЕНИЕ ДЕПОЗИТОВ + ОТСЛЕЖИВАНИЕ СУММ

         1. Евгений(7000) → Алексей(13000): 7000₽
         BankTransfer(to: Алексей, 7000)
         amountReceivedFromBank[Алексей] = 7000₽
         amountSentViaBank[Евгений] = 7000₽
         Остаток: Евгений 0₽, Алексей 6000₽

         2. Игорь(5000) → Алексей(6000): 5000₽
         BankTransfer(to: Алексей, 5000)
         amountReceivedFromBank[Алексей] = 12000₽
         amountSentViaBank[Игорь] = 5000₽
         Остаток: Игорь 0₽, Алексей 1000₽

         3. Жанна(2000) → Алексей(1000): 1000₽
         BankTransfer(to: Алексей, 1000)
         amountReceivedFromBank[Алексей] = 13000₽
         amountSentViaBank[Жанна] = 1000₽
         Остаток: Жанна 1000₽, Алексей 0₽

         4. Жанна(1000) → Борис(7000): 1000₽
         BankTransfer(to: Борис, 1000)
         amountReceivedFromBank[Борис] = 1000₽
         amountSentViaBank[Жанна] = 2000₽ (total)
         Остаток: Жанна 0₽, Борис 6000₽

         ШАГ 8: ОБРАБОТКА ПЕРЕПЛАТЫ (строки 207-214 SettlementService.swift):
         Евгений внёс 7000₽, но его долг был только 5000₽ (netCashBeforeRakeback = -5000₽)
         Переплата = 7000 - 5000 = 2000₽ → банк возвращает Евгению 2000₽
         BankTransfer(to: Евгений, 2000)

         ПЕРЕВОДЫ ИЗ БАНКА (5 переводов):
         - Алексею: 7000₽ (от Евгения)
         - Алексею: 5000₽ (от Игоря)
         - Алексею: 1000₽ (от Жанны)
         - Борису: 1000₽ (от Жанны)
         - Евгению: 2000₽ (возврат переплаты)
         ИТОГО Алексей получил через банк: 13000₽ ✅
         ИТОГО Борис получил через банк: 1000₽
         Борису ещё нужно: 7000 - 1000 = 6000₽
         
         ПРЯМЫЕ ПЕРЕВОДЫ:
         ----------------

         ШАГ 6: ФОРМИРОВАНИЕ ОКОНЧАТЕЛЬНЫХ CREDITORS (строки 162-169)
         adjustedWin = netCash - amountReceivedFromBank

         - Алексей: 13000 - 13000 = 0₽ → НЕ попадает в creditors ✅
         - Борис: 7000 - 1000 = 6000₽ ✅
         - Виктор: 3000 - 0 = 3000₽ ✅
         - Григорий: 3000 - 0 = 3000₽ ✅
         Итого creditors: 12000₽

         ШАГ 7: ФОРМИРОВАНИЕ ОКОНЧАТЕЛЬНЫХ DEBTORS (строки 184-191)
         adjustedDebt = abs(netCash) - amountSentViaBank

         - Дмитрий: 2000 - 0 = 2000₽ ✅
         - Евгений: 5000 - 7000 = -2000 → НЕ попадает в debtors (переплата) ✅
         - Жанна: 4000 - 2000 = 2000₽ ✅
         - Зинаида: 7000 - 0 = 7000₽ ✅
         - Игорь: 8000 - 5000 = 3000₽ ✅
         Итого debtors: 14000₽

         ✅ Баланс creditors и debtors:
         Creditors должны получить: 12000₽
         Debtors должны отдать: 14000₽

         Почему 14000 ≠ 12000?
         Разница 2000₽ = переплата Евгению, которую банк вернёт.

         Проверка распределения через банк:
         - Евгений внёс: 7000₽
         - Из них распределено победителям: 7000₽ (всё ушло Алексею)
         - Его долг был: 5000₽
         - Переплата: 7000 - 5000 = 2000₽ → банк возвращает Евгению 2000₽ ✅

         Итоговая картина денежных потоков:
         - Победители получают через банк: 13000₽ (Алексею полностью)
         - Победители получают через P2P: 12000₽ (Борису, Виктору, Григорию)
         - Должники платят через банк: 14000₽ (7000 + 2000 + 5000)
         - Должники платят через P2P: 12000₽
         - Банк возвращает переплату: 2000₽ (Евгению)

         Баланс банка:
         Поступило: 14000₽
         Выдано: 13000₽ (победителям) + 2000₽ (возврат переплаты) = 15000₽
         Банк в минусе: -1000₽? НЕТ! Переплата Евгения уже учтена в его депозите.

         Правильный баланс:
         - Евгений внёс 7000₽, из них 5000₽ его долг + 2000₽ переплата
         - Из 7000₽ победителям ушло 7000₽, а 2000₽ переплаты вернулись Евгению
         - Фактически Евгений профинансировал 5000₽ из своего депозита
         - Итого через банк профинансировано: 5000₽ (Евгений) + 2000₽ (Жанна) + 5000₽ (Игорь) = 12000₽
         - Но Алексей получил 13000₽! Откуда лишние 1000₽?
         - Это часть переплаты Евгения, которая сначала ушла победителю, но потом вернулась

         ШАГ 9: ЖАДНЫЙ P2P АЛГОРИТМ (строки 217-253):
         Creditors (по убыванию): Борис(6000), Виктор(3000), Григорий(3000)
         Debtors (по убыванию): Зинаида(7000), Игорь(3000), Дмитрий(2000), Жанна(2000)

         ПРИМЕЧАНИЕ: Дмитрий и Жанна оба имеют adjustedDebt = 2000₽.
         Порядок между ними зависит от реализации сортировки (stable sort).
         Тест ожидает, что Дмитрий идёт первым.

         1. Зинаида(7000) → Борис(6000): 6000₽
         Остаток: Зинаида 1000₽, Борис 0₽

         2. Зинаида(1000) → Виктор(3000): 1000₽
         Остаток: Зинаида 0₽, Виктор 2000₽

         3. Игорь(3000) → Виктор(2000): 2000₽
         Остаток: Игорь 1000₽, Виктор 0₽

         4. Игорь(1000) → Григорий(3000): 1000₽
         Остаток: Игорь 0₽, Григорий 2000₽

         5. Дмитрий(2000) → Григорий(2000): 2000₽
         Остаток: Дмитрий 0₽, Григорий 0₽

         Жанна не участвует в P2P переводах, так как все creditors уже полностью покрыты!
         Её долг 2000₽ был полностью покрыт через её депозит в банк.

         ИТОГО P2P ПЕРЕВОДОВ: 5 (как и ожидается в тесте на строках 267-271) ✅
         */
        
        // Given: Реалистичная домашняя игра на 9 человек
        let session = SessionBuilder()
            .withChipRatio(1)
        // Победители
            .addPlayer("Алексей", buyIn: 10000, cashOut: 23000)  // +13000₽
            .addPlayer("Борис", buyIn: 10000, cashOut: 17000)    // +7000₽
            .addPlayer("Виктор", buyIn: 10000, cashOut: 13000)   // +3000₽
            .addPlayer("Григорий", buyIn: 10000, cashOut: 13000) // +3000₽
        // Проигравшие
            .addPlayer("Дмитрий", buyIn: 10000, cashOut: 8000)   // -2000₽
            .addPlayer("Евгений", buyIn: 10000, cashOut: 5000)   // -5000₽
            .addPlayer("Жанна", buyIn: 10000, cashOut: 6000)     // -4000₽
            .addPlayer("Зинаида", buyIn: 10000, cashOut: 3000)   // -7000₽
            .addPlayer("Игорь", buyIn: 10000, cashOut: 2000)     // -8000₽
        // Банк сессии
            .withBank()
        // Депозиты (покрываем разные сценарии)
            .addBankDeposit(player: "Евгений", amount: 7000)  // Сценарий 1: Переплата (долг 5000₽, внёс 7000₽)
            .addBankDeposit(player: "Жанна", amount: 2000)    // Сценарий 2: Частичный депозит
            .addBankDeposit(player: "Игорь", amount: 5000)    // Сценарий 2: Частичный депозит
        // Дмитрий и Зинаида НЕ вносили (Сценарий 3: платят напрямую)
            .build()
        
        // When: Рассчитываем settlement с учётом банка
        let result = service.calculate(for: session)
        guard let bank = session.bank else {
            Issue.record("Банк сессии не найден")
            return
        }
        
        // DEBUG: Выводим все переводы для отладки
        print("\n=== ПЕРЕВОДЫ ИЗ БАНКА (\(result.bankTransfers.count)) ===")
        for transfer in result.bankTransfers {
            print("Банк → \(transfer.to.name): \(transfer.amount)₽")
        }
        
        print("\n=== ПРЯМЫЕ ПЕРЕВОДЫ МЕЖДУ ИГРОКАМИ (\(result.playerTransfers.count)) ===")
        for transfer in result.playerTransfers {
            print("\(transfer.from.name) → \(transfer.to.name): \(transfer.amount)₽")
        }
        
        print("\nБаланс банка: \(bank.netBalance)₽")
        
        // Then: Проверяем балансы всех игроков
        assertBalance(result, player: "Алексей", netCash: 13000)
        assertBalance(result, player: "Борис", netCash: 7000)
        assertBalance(result, player: "Виктор", netCash: 3000)
        assertBalance(result, player: "Григорий", netCash: 3000)
        assertBalance(result, player: "Дмитрий", netCash: -2000)
        assertBalance(result, player: "Евгений", netCash: -5000)
        assertBalance(result, player: "Жанна", netCash: -4000)
        assertBalance(result, player: "Зинаида", netCash: -7000)
        assertBalance(result, player: "Игорь", netCash: -8000)
        
        // Проверяем переводы из банка (5 переводов)
        assertBankTransferCount(result, count: 5)
        // Распределение депозитов победителям
        assertBankTransfer(result, to: "Алексей", amount: 7000)  // от Евгения
        assertBankTransfer(result, to: "Алексей", amount: 5000)  // от Игоря
        assertBankTransfer(result, to: "Алексей", amount: 1000)  // от Жанны
        assertBankTransfer(result, to: "Борис", amount: 1000)    // от Жанны
        // Возврат переплаты
        assertBankTransfer(result, to: "Евгений", amount: 2000)  // возврат переплаты

        // Проверяем прямые переводы (5 переводов)
        // Creditors после банка: Борис(6000), Виктор(3000), Григорий(3000)
        // Debtors: Зинаида(7000), Игорь(3000), Дмитрий(2000), Жанна(2000)
        assertPlayerTransferCount(result, count: 5)
        assertPlayerTransfer(result, from: "Зинаида", to: "Борис", amount: 6000)
        assertPlayerTransfer(result, from: "Зинаида", to: "Виктор", amount: 1000)
        assertPlayerTransfer(result, from: "Игорь", to: "Виктор", amount: 2000)
        assertPlayerTransfer(result, from: "Игорь", to: "Григорий", amount: 1000)
        assertPlayerTransfer(result, from: "Дмитрий", to: "Григорий", amount: 2000)
    }
    
    @Test("9 игроков с рейком 5000₽, остающимся в банке")
    func ninePlayerTestWithRake() {
        /*
         СЦЕНАРИЙ С РЕЙКОМ:
         
         Total BuyIn:  90000₽ (9 игроков × 10000₽)
         Total CashOut: 85000₽ (после удержания рейка)
         Rake:          5000₽ (остаётся в банке сессии)
         
         ВЫИГРАВШИЕ (total: +21000₽):
         - Алексей: 10000 → 20000 = +10000₽
         - Борис:   10000 → 16000 = +6000₽
         - Виктор:  10000 → 13000 = +3000₽
         - Григорий: 10000 → 12000 = +2000₽
         
         ПРОИГРАВШИЕ (total: -26000₽):
         - Дмитрий: 10000 → 8000 = -2000₽
         - Евгений: 10000 → 6000 = -4000₽
         - Жанна:   10000 → 5000 = -5000₽
         - Зинаида: 10000 → 3000 = -7000₽
         - Игорь:   10000 → 2000 = -8000₽
         
         БАЛАНС ИГРОКОВ:
         Выигрыши (+21000) + Проигрыши (-26000) = -5000₽
         Эта разница равна рейку!
         
         ДЕПОЗИТЫ В БАНК:
         - Евгений: 4000₽ (полное покрытие долга 4000₽)
         - Жанна:   5000₽ (полное покрытие долга 5000₽)
         - Зинаида: 7000₽ (полное покрытие долга 7000₽)
         Total deposits: 16000₽
         
         ПРОВЕРКИ:
         1. Все переводы между игроками корректны
         2. Сумма балансов игроков = -5000₽ (равна рейку)
         3. Остаток в банке = +5000₽ после всех расчётов
         4. Общий баланс системы = 0 (игроки + банк)
         */
        
        // Given: Сессия на 9 игроков с рейком 5000₽
        let session = SessionBuilder()
            .withChipRatio(1)
            .withRake(5000)  // 5000 фишек рейка
        // Выигравшие
            .addPlayer("Алексей", buyIn: 10000, cashOut: 20000)  // +10000₽
            .addPlayer("Борис", buyIn: 10000, cashOut: 16000)    // +6000₽
            .addPlayer("Виктор", buyIn: 10000, cashOut: 13000)   // +3000₽
            .addPlayer("Григорий", buyIn: 10000, cashOut: 12000) // +2000₽
        // Проигравшие
            .addPlayer("Дмитрий", buyIn: 10000, cashOut: 8000)   // -2000₽
            .addPlayer("Евгений", buyIn: 10000, cashOut: 6000)   // -4000₽
            .addPlayer("Жанна", buyIn: 10000, cashOut: 5000)     // -5000₽
            .addPlayer("Зинаида", buyIn: 10000, cashOut: 3000)   // -7000₽
            .addPlayer("Игорь", buyIn: 10000, cashOut: 2000)     // -8000₽
        // Банк с депозитами от проигравших
            .withBank()
            .addBankDeposit(player: "Евгений", amount: 4000)  // Полное покрытие
            .addBankDeposit(player: "Жанна", amount: 5000)    // Полное покрытие
            .addBankDeposit(player: "Зинаида", amount: 7000)  // Полное покрытие
            .build()
        
        // When: Рассчитываем settlement
        let result = service.calculate(for: session)
        
        // DEBUG: Выводим все переводы для отладки
        print("\n=== ТЕСТ С РЕЙКОМ: ПЕРЕВОДЫ ИЗ БАНКА (\(result.bankTransfers.count)) ===")
        for transfer in result.bankTransfers {
            print("Банк → \(transfer.to.name): \(transfer.amount)₽")
        }
        
        print("\n=== ТЕСТ С РЕЙКОМ: ПРЯМЫЕ ПЕРЕВОДЫ (\(result.playerTransfers.count)) ===")
        for transfer in result.playerTransfers {
            print("\(transfer.from.name) → \(transfer.to.name): \(transfer.amount)₽")
        }
        
        // Then: Проверяем балансы всех игроков
        assertBalance(result, player: "Алексей", netCash: 10000)
        assertBalance(result, player: "Борис", netCash: 6000)
        assertBalance(result, player: "Виктор", netCash: 3000)
        assertBalance(result, player: "Григорий", netCash: 2000)
        assertBalance(result, player: "Дмитрий", netCash: -2000)
        assertBalance(result, player: "Евгений", netCash: -4000)
        assertBalance(result, player: "Жанна", netCash: -5000)
        assertBalance(result, player: "Зинаида", netCash: -7000)
        assertBalance(result, player: "Игорь", netCash: -8000)
        
        // Проверяем сумму всех балансов игроков
        let totalPlayerBalance = result.balances.reduce(0) { $0 + $1.netCash }
        #expect(totalPlayerBalance == -5000, "Сумма балансов игроков должна быть -5000₽ (равна рейку)")
        
        // Проверяем остаток в банке после всех переводов
        guard let bank = session.bank else {
            Issue.record("Банк сессии не найден")
            return
        }
        
        let totalBankTransfers = result.bankTransfers.reduce(0) { $0 + $1.amount }
        let remainingBankBalance = bank.netBalance - totalBankTransfers
        
        print("\n=== ТЕСТ С РЕЙКОМ: БАЛАНСЫ ===")
        print("Всего депозитов в банк: \(bank.totalDeposited)₽")
        print("Всего выводов из банка: \(bank.totalWithdrawn)₽")
        print("Чистый баланс банка: \(bank.netBalance)₽")
        print("Сумма переводов из банка в settlement: \(totalBankTransfers)₽")
        print("Остаток в банке после settlement: \(remainingBankBalance)₽")
        print("Ожидаемый рейк: \(session.rakeAmount * session.chipsToCashRatio)₽")
        print("Суммарный баланс игроков: \(totalPlayerBalance)₽")
        print("Баланс системы (игроки + банк): \(totalPlayerBalance + remainingBankBalance)₽")
    }

    @Test("Сессия с распределением рейкбека между игроками")
    func testWithRakebackDistribution() {
        /*
         ОПИСАНИЕ СЕССИИ:
         ================

         Тест проверяет корректность расчётов при распределении рейкбека между игроками.
         Курс: 1 фишка = 1 рубль.
         Рейк: 10,000 фишек (10,000₽)

         ИГРОКИ И ИХ РЕЗУЛЬТАТЫ:
         -----------------------
         1. Алексей  - большой проигрыш: 20000 → 5000 = -15000₽
         2. Борис    - средний проигрыш: 15000 → 5000 = -10000₽
         3. Виктор   - большой выигрыш:  10000 → 30000 = +20000₽
         4. Григорий - небольшой выигрыш: 10000 → 15000 = +5000₽
         5. Дмитрий  - небольшой проигрыш: 10000 → 10000 = 0₽ (в ноль)

         Проверка баланса БЕЗ рейка:
         Выигрыши: +20000 + 5000 = +25000₽
         Проигрыши: -15000 - 10000 = -25000₽
         Баланс: 0₽ ✅

         На столе осталось 10,000 фишек (рейк) → 10,000₽

         РАСПРЕДЕЛЕНИЕ РЕЙКБЕКА:
         -----------------------
         Дом возвращает часть рейка игрокам:
         - Алексей получает 3,000₽ рейкбека (20% от рейка)
         - Борис получает 2,000₽ рейкбека (20% от рейка)
         - Виктор получает 5,000₽ рейкбека (50% от рейка)

         Итого распределено: 10,000₽ (весь рейк)
         Дом оставляет себе: 0₽

         БАЛАНСЫ С УЧЁТОМ РЕЙКБЕКА:
         --------------------------
         1. Алексей: -15000₽ + 3000₽ = -12000₽ (долг уменьшился)
         2. Борис:   -10000₽ + 2000₽ = -8000₽  (долг уменьшился)
         3. Виктор:  +20000₽ + 5000₽ = +25000₽ (выплата увеличилась)
         4. Григорий: +5000₽ + 0₽ = +5000₽     (без изменений)
         5. Дмитрий:  0₽ + 0₽ = 0₽             (без изменений)

         Проверка баланса С рейкбеком:
         Кредиторы: +25000 + 5000 = +30000₽
         Должники:  -12000 - 8000 = -20000₽
         Разница: +10000₽ (равна распределённому рейкбеку) ✅

         ОПЕРАЦИИ С БАНКОМ:
         ------------------
         Депозиты от должников:
         - Алексей вносит 12,000₽ (весь долг)
         - Борис вносит 8,000₽ (весь долг)

         Итого в банке: 20,000₽
         Должны выдать кредиторам: 30,000₽
         Разница: -10,000₽ (банк в минусе на сумму рейкбека)

         ОЖИДАЕМЫЕ ПЕРЕВОДЫ:
         -------------------
         Из банка:
         - Виктор получает 20,000₽ (весь баланс банка уходит ему)

         Прямые переводы:
         - Григорий получает 5,000₽ напрямую
         - Виктор получает ещё 5,000₽ напрямую (докомпенсация)

         Алгоритм распределения определит оптимальные пути переводов.

         ПРОВЕРКИ:
         ---------
         1. ✅ Рейкбек правильно применяется к балансам (balance.rakeback)
         2. ✅ Балансы с учётом рейкбека корректны (netCash)
         3. ✅ Переводы между игроками корректны
         4. ✅ Общий баланс системы = 0 (с учётом рейкбека в банке)
         */

        // Given: Сессия на 5 игроков с рейком 10,000₽ и распределённым рейкбеком
        let session = SessionBuilder()
            .withChipRatio(1)
            .withRake(10000)  // 10,000 фишек рейка
        // Проигравшие
            .addPlayer("Алексей", buyIn: 20000, cashOut: 5000)   // -15000₽
            .addPlayer("Борис", buyIn: 15000, cashOut: 5000)     // -10000₽
        // Выигравшие
            .addPlayer("Виктор", buyIn: 10000, cashOut: 30000)   // +20000₽
            .addPlayer("Григорий", buyIn: 10000, cashOut: 15000) // +5000₽
        // В ноль
            .addPlayer("Дмитрий", buyIn: 10000, cashOut: 10000)  // 0₽
        // Банк с депозитами
            .withBank()
            .addBankDeposit(player: "Алексей", amount: 12000)  // Вносит с учётом рейкбека
            .addBankDeposit(player: "Борис", amount: 8000)     // Вносит с учётом рейкбека
        // Распределение рейкбека
            .addRakebackDistribution(player: "Алексей", amount: 3000)
            .addRakebackDistribution(player: "Борис", amount: 2000)
            .addRakebackDistribution(player: "Виктор", amount: 5000)
            .build()

        // When: Рассчитываем settlement
        let result = service.calculate(for: session)

        // DEBUG: Выводим информацию для отладки
        print("\n=== ТЕСТ С РЕЙКБЕКОМ: БАЛАНСЫ ИГРОКОВ ===")
        for balance in result.balances {
            let netChips = balance.cashOut - balance.buyIn
            print("\(balance.player.name): закуп=\(balance.buyIn), вывод=\(balance.cashOut), " +
                  "фишки=\(netChips >= 0 ? "+" : "")\(netChips), " +
                  "рейкбек=\(balance.rakeback)₽, " +
                  "итого=\(balance.netCash >= 0 ? "+" : "")\(balance.netCash)₽")
        }

        print("\n=== ТЕСТ С РЕЙКБЕКОМ: ПЕРЕВОДЫ ИЗ БАНКА (\(result.bankTransfers.count)) ===")
        for transfer in result.bankTransfers {
            print("Банк → \(transfer.to.name): \(transfer.amount)₽")
        }

        print("\n=== ТЕСТ С РЕЙКБЕКОМ: ПРЯМЫЕ ПЕРЕВОДЫ (\(result.playerTransfers.count)) ===")
        for transfer in result.playerTransfers {
            print("\(transfer.from.name) → \(transfer.to.name): \(transfer.amount)₽")
        }

        // Then: Проверяем рейкбек у игроков
        assertRakeback(result, player: "Алексей", amount: 3000)
        assertRakeback(result, player: "Борис", amount: 2000)
        assertRakeback(result, player: "Виктор", amount: 5000)
        assertRakeback(result, player: "Григорий", amount: 0)
        assertRakeback(result, player: "Дмитрий", amount: 0)

        // Проверяем балансы с учётом рейкбека
        assertBalance(result, player: "Алексей", netCash: -12000)   // -15000 + 3000
        assertBalance(result, player: "Борис", netCash: -8000)      // -10000 + 2000
        assertBalance(result, player: "Виктор", netCash: 25000)     // +20000 + 5000
        assertBalance(result, player: "Григорий", netCash: 5000)    // +5000 + 0
        assertBalance(result, player: "Дмитрий", netCash: 0)        // 0 + 0

        // Проверяем, что сумма балансов игроков = распределённый рейкбек
        let totalPlayerBalance = result.balances.reduce(0) { $0 + $1.netCash }
        let totalRakebackDistributed = result.balances.reduce(0) { $0 + $1.rakeback }
        #expect(totalPlayerBalance == totalRakebackDistributed,
                "Сумма балансов игроков (\(totalPlayerBalance)₽) должна равняться распределённому рейкбеку (\(totalRakebackDistributed)₽)")

        // Проверяем баланс банка
        guard let bank = session.bank else {
            Issue.record("Банк сессии не найден")
            return
        }

        let totalBankTransfers = result.bankTransfers.reduce(0) { $0 + $1.amount }
        let remainingBankBalance = bank.netBalance - totalBankTransfers

        print("\n=== ТЕСТ С РЕЙКБЕКОМ: БАЛАНС СИСТЕМЫ ===")
        print("Депозитов в банк: \(bank.totalDeposited)₽")
        print("Выводов из банка: \(bank.totalWithdrawn)₽")
        print("Чистый баланс банка: \(bank.netBalance)₽")
        print("Переводов из банка в settlement: \(totalBankTransfers)₽")
        print("Остаток в банке: \(remainingBankBalance)₽")
        print("Распределённый рейкбек: \(totalRakebackDistributed)₽")
        print("Баланс игроков: \(totalPlayerBalance)₽")
        print("Баланс системы (игроки + банк): \(totalPlayerBalance + remainingBankBalance)₽")

        // Проверяем, что общий баланс системы = распределённому рейкбеку
        // Когда рейкбек полностью возвращается игрокам, система в плюсе на эту сумму
        #expect(totalPlayerBalance + remainingBankBalance == totalRakebackDistributed,
                "Баланс системы (\(totalPlayerBalance + remainingBankBalance)₽) должен равняться распределённому рейкбеку (\(totalRakebackDistributed)₽)")
    }

    @Test("Сессия с частичным распределением рейкбека - дом оставляет себе часть")
    func testWithPartialRakebackDistribution() {
        /*
         ОПИСАНИЕ СЕССИИ:
         ================

         Тест проверяет корректность расчётов когда дом оставляет себе часть рейка.
         Курс: 1 фишка = 1 рубль.
         Рейк: 10,000 фишек (10,000₽)

         ИГРОКИ И ИХ РЕЗУЛЬТАТЫ:
         -----------------------
         1. Алексей  - большой проигрыш: 20000 → 5000 = -15000₽
         2. Борис    - средний проигрыш: 15000 → 5000 = -10000₽
         3. Виктор   - большой выигрыш:  10000 → 20000 = +10000₽
         4. Григорий - небольшой выигрыш: 10000 → 15000 = +5000₽
         5. Дмитрий  - в ноль: 10000 → 10000 = 0₽

         Проверка баланса БЕЗ рейка:
         Выигрыши: +10000 + 5000 = +15000₽
         Проигрыши: -15000 - 10000 = -25000₽
         Баланс: -10000₽ (это рейк!) ✅

         Всего закупили: 65,000 фишек
         Всего вывели: 55,000 фишек
         На столе осталось: 10,000 фишек (рейк) → 10,000₽

         РАСПРЕДЕЛЕНИЕ РЕЙКБЕКА (ЧАСТИЧНОЕ):
         ------------------------------------
         Дом возвращает только 60% рейка игрокам:
         - Алексей получает 2,000₽ рейкбека (20% от рейка)
         - Борис получает 1,000₽ рейкбека (10% от рейка)
         - Виктор получает 3,000₽ рейкбека (30% от рейка)

         Итого распределено: 6,000₽ (60% рейка)
         Дом оставляет себе: 4,000₽ (40% рейка) ← ПРИБЫЛЬ ДОМА

         БАЛАНСЫ С УЧЁТОМ РЕЙКБЕКА:
         --------------------------
         1. Алексей: -15000₽ + 2000₽ = -13000₽ (долг уменьшился)
         2. Борис:   -10000₽ + 1000₽ = -9000₽  (долг уменьшился)
         3. Виктор:  +10000₽ + 3000₽ = +13000₽ (выплата увеличилась)
         4. Григорий: +5000₽ + 0₽ = +5000₽     (без изменений)
         5. Дмитрий:  0₽ + 0₽ = 0₽             (без изменений)

         Проверка баланса С рейкбеком:
         Кредиторы: +13000 + 5000 = +18000₽
         Должники:  -13000 - 9000 = -22000₽
         Разница: -4000₽ (недостача = нераспределённый рейк) ✅

         ОПЕРАЦИИ С БАНКОМ:
         ------------------
         Депозиты от должников:
         - Алексей вносит 13,000₽ (весь долг с учётом рейкбека)
         - Борис вносит 9,000₽ (весь долг с учётом рейкбека)

         Итого в банке: 22,000₽
         Должны выдать кредиторам: 18,000₽
         Разница: +4,000₽ (остаток = прибыль дома)

         ПРИБЫЛЬ ДОМА:
         -------------
         В банке останется 4,000₽ (нераспределённый рейк)
         Это доход дома от сессии!

         ПРОВЕРКИ:
         ---------
         1. ✅ Рейкбек правильно применяется к балансам
         2. ✅ Балансы с учётом рейкбека корректны
         3. ✅ Баланс системы = распределённому рейкбеку (6,000₽)
         4. ✅ В банке остаётся прибыль дома (4,000₽)
         */

        // Given: Сессия на 5 игроков с рейком 10,000₽ и ЧАСТИЧНЫМ распределением рейкбека (60%)
        let session = SessionBuilder()
            .withChipRatio(1)
            .withRake(10000)  // 10,000 фишек рейка
        // Проигравшие
            .addPlayer("Алексей", buyIn: 20000, cashOut: 5000)   // -15000₽
            .addPlayer("Борис", buyIn: 15000, cashOut: 5000)     // -10000₽
        // Выигравшие
            .addPlayer("Виктор", buyIn: 10000, cashOut: 20000)   // +10000₽
            .addPlayer("Григорий", buyIn: 10000, cashOut: 15000) // +5000₽
        // В ноль
            .addPlayer("Дмитрий", buyIn: 10000, cashOut: 10000)  // 0₽
        // Банк с депозитами
            .withBank()
            .addBankDeposit(player: "Алексей", amount: 13000)  // Вносит с учётом рейкбека
            .addBankDeposit(player: "Борис", amount: 9000)     // Вносит с учётом рейкбека
        // Распределение рейкбека (ТОЛЬКО 60% от рейка)
            .addRakebackDistribution(player: "Алексей", amount: 2000)  // 20% рейка
            .addRakebackDistribution(player: "Борис", amount: 1000)    // 10% рейка
            .addRakebackDistribution(player: "Виктор", amount: 3000)   // 30% рейка
            .build()

        // When: Рассчитываем settlement
        let result = service.calculate(for: session)

        // DEBUG: Выводим информацию для отладки
        print("\n=== ТЕСТ С ЧАСТИЧНЫМ РЕЙКБЕКОМ: БАЛАНСЫ ИГРОКОВ ===")
        for balance in result.balances {
            let netChips = balance.cashOut - balance.buyIn
            print("\(balance.player.name): закуп=\(balance.buyIn), вывод=\(balance.cashOut), " +
                  "фишки=\(netChips >= 0 ? "+" : "")\(netChips), " +
                  "рейкбек=\(balance.rakeback)₽, " +
                  "итого=\(balance.netCash >= 0 ? "+" : "")\(balance.netCash)₽")
        }

        print("\n=== ТЕСТ С ЧАСТИЧНЫМ РЕЙКБЕКОМ: ПЕРЕВОДЫ ИЗ БАНКА (\(result.bankTransfers.count)) ===")
        for transfer in result.bankTransfers {
            print("Банк → \(transfer.to.name): \(transfer.amount)₽")
        }

        print("\n=== ТЕСТ С ЧАСТИЧНЫМ РЕЙКБЕКОМ: ПРЯМЫЕ ПЕРЕВОДЫ (\(result.playerTransfers.count)) ===")
        for transfer in result.playerTransfers {
            print("\(transfer.from.name) → \(transfer.to.name): \(transfer.amount)₽")
        }

        // Then: Проверяем рейкбек у игроков
        assertRakeback(result, player: "Алексей", amount: 2000)
        assertRakeback(result, player: "Борис", amount: 1000)
        assertRakeback(result, player: "Виктор", amount: 3000)
        assertRakeback(result, player: "Григорий", amount: 0)
        assertRakeback(result, player: "Дмитрий", amount: 0)

        // Проверяем балансы с учётом рейкбека
        assertBalance(result, player: "Алексей", netCash: -13000)   // -15000 + 2000
        assertBalance(result, player: "Борис", netCash: -9000)      // -10000 + 1000
        assertBalance(result, player: "Виктор", netCash: 13000)     // +10000 + 3000
        assertBalance(result, player: "Григорий", netCash: 5000)    // +5000 + 0
        assertBalance(result, player: "Дмитрий", netCash: 0)        // 0 + 0

        // Проверяем суммы
        let totalPlayerBalance = result.balances.reduce(0) { $0 + $1.netCash }
        let totalRakebackDistributed = result.balances.reduce(0) { $0 + $1.rakeback }

        #expect(totalRakebackDistributed == 6000,
                "Распределено должно быть 6000₽ рейкбека (60% от 10000₽)")

        // Баланс игроков = -4000₽ (дефицит, покрываемый рейкбеком)
        #expect(totalPlayerBalance == -4000,
                "Сумма балансов игроков (\(totalPlayerBalance)₽) должна быть -4000₽ (недостача от нераспределённого рейка)")

        // Проверяем баланс банка и прибыль дома
        guard let bank = session.bank else {
            Issue.record("Банк сессии не найден")
            return
        }

        let totalBankTransfers = result.bankTransfers.reduce(0) { $0 + $1.amount }
        let remainingBankBalance = bank.netBalance - totalBankTransfers
        let totalRake = session.rakeAmount * session.chipsToCashRatio
        let houseProfit = totalRake - totalRakebackDistributed

        print("\n=== ТЕСТ С ЧАСТИЧНЫМ РЕЙКБЕКОМ: БАЛАНС СИСТЕМЫ ===")
        print("Депозитов в банк: \(bank.totalDeposited)₽")
        print("Выводов из банка: \(bank.totalWithdrawn)₽")
        print("Чистый баланс банка: \(bank.netBalance)₽")
        print("Переводов из банка в settlement: \(totalBankTransfers)₽")
        print("Остаток в банке: \(remainingBankBalance)₽")
        print("Всего рейка: \(totalRake)₽")
        print("Распределённый рейкбек: \(totalRakebackDistributed)₽")
        print("Прибыль дома (нераспределённый рейк): \(houseProfit)₽")
        print("Баланс игроков: \(totalPlayerBalance)₽")
        print("Баланс системы (игроки + банк): \(totalPlayerBalance + remainingBankBalance)₽")

        // Проверяем прибыль дома
        #expect(houseProfit == 4000,
                "Прибыль дома должна быть 4000₽ (40% от 10000₽)")

        #expect(remainingBankBalance == houseProfit,
                "Остаток в банке (\(remainingBankBalance)₽) должен равняться прибыли дома (\(houseProfit)₽)")

        // Проверяем баланс системы
        // Баланс игроков (-4000) + Остаток в банке (4000) = 0
        #expect(totalPlayerBalance + remainingBankBalance == 0,
                "Баланс системы должен быть 0: игроки \(totalPlayerBalance)₽ + банк \(remainingBankBalance)₽ = \(totalPlayerBalance + remainingBankBalance)₽")
    }

    @Test("ЭТАЛОННЫЙ ТЕСТ: банк + рейк + рейкбек + расходы - все сценарии")
    func comprehensiveReferenceTest() {
        /*
         ЭТАЛОННАЯ СЕССИЯ ДЛЯ ПРОВЕРКИ ВСЕХ РАСЧЁТОВ
         ============================================

         Этот тест проверяет ВСЕ аспекты settlement одновременно:
         - ✅ Операции с банком (депозиты, withdrawals, переплаты)
         - ✅ Рейк и распределение рейкбека
         - ✅ Расходы с различными сценариями распределения
         - ✅ Переводы между игроками (через банк и P2P)

         ПАРАМЕТРЫ СЕССИИ:
         -----------------
         Курс: 1 фишка = 1 рубль
         Рейк: 1,000₽ (зарезервирован в банке)
         Чаевые: 500₽ (зарезервированы в банке)

         ИГРОКИ (6 человек):
         -------------------
         1. Алексей  - Большой победитель: 10,000₽ → 22,000₽ = +12,000₽ (с рейкбеком)
         2. Борис    - Средний победитель: 8,000₽ → 13,000₽ = +5,000₽ (без рейкбека)
         3. Виктор   - Малый победитель:   5,000₽ → 6,500₽ = +1,500₽ (без рейкбека)
         4. Григорий - Большой проигравший: 12,000₽ → 5,000₽ = -7,000₽
         5. Дмитрий  - Средний проигравший: 7,000₽ → 6,000₽ = -1,000₽
         6. Евгений  - Break even:          6,000₽ → 6,000₽ = 0₽

         Проверка: +12,000 + 5,000 + 1,500 - 7,000 - 1,000 = +10,500₽
         Но есть рейк 1,000₽ + чаевые 500₽ = 1,500₽
         Итого: +10,500 - 1,500 = +9,000₽ (ожидается positive из-за рейкбека)

         РАСХОДЫ (4 вида):
         -----------------
         1. Еда (3,000₽) - полностью распределена поровну между всеми (500₽ каждый)
            Плательщик: Алексей → получит возврат 3,000₽

         2. Аренда стола (2,000₽) - распределена неравномерно
            Плательщик: Борис → получит возврат 2,000₽
            - Алексей: 400₽
            - Борис: 350₽
            - Виктор: 300₽
            - Григорий: 350₽
            - Дмитрий: 300₽
            - Евгений: 300₽

         3. Напитки (900₽) - частично распределена (только 3 игрока)
            Плательщик: Виктор → получит возврат 900₽
            - Алексей: 300₽
            - Борис: 300₽
            - Виктор: 300₽

         4. Чаевые дилеру (600₽) - НЕ распределена (незавершенный расход)
            Плательщик: нет

         Итого расходов: 6,500₽
         Распределено: 5,900₽
         Не распределено: 600₽

         ВЛИЯНИЕ РАСХОДОВ НА БАЛАНСЫ:
         ----------------------------
         Плательщики получают возврат:
         - Алексей: +3,000₽ (за еду)
         - Борис: +2,000₽ (за аренду)
         - Виктор: +900₽ (за напитки)

         Все платят свою долю:
         - Алексей: -1,200₽ (500 еда + 400 аренда + 300 напитки)
         - Борис: -1,150₽ (500 еда + 350 аренда + 300 напитки)
         - Виктор: -1,100₽ (500 еда + 300 аренда + 300 напитки)
         - Григорий: -850₽ (500 еда + 350 аренда)
         - Дмитрий: -800₽ (500 еда + 300 аренда)
         - Евгений: -800₽ (500 еда + 300 аренда)

         ЧИСТЫЕ БАЛАНСЫ С УЧЁТОМ РАСХОДОВ (до рейкбека):
         -----------------------------------------------
         - Алексей: +12,000 + 3,000 - 1,200 = +13,800₽
         - Борис: +5,000 + 2,000 - 1,150 = +5,850₽
         - Виктор: +1,500 + 900 - 1,100 = +1,300₽
         - Григорий: -7,000 - 850 = -7,850₽
         - Дмитрий: -1,000 - 800 = -1,800₽
         - Евгений: 0 - 800 = -800₽

         Проверка: +13,800 + 5,850 + 1,300 - 7,850 - 1,800 - 800 = +10,500₽ ✅

         РЕЙКБЕК (распределено 700₽ из 1,000₽):
         --------------------------------------
         - Алексей: 300₽ рейкбека (большой победитель)
         - Виктор: 400₽ рейкбека (малый победитель)
         - Дом оставляет себе: 300₽

         ИТОГОВЫЕ БАЛАНСЫ С РЕЙКБЕКОМ:
         -----------------------------
         - Алексей: +13,800 + 300 = +14,100₽
         - Борис: +5,850₽
         - Виктор: +1,300 + 400 = +1,700₽
         - Григорий: -7,850₽
         - Дмитрий: -1,800₽
         - Евгений: -800₽

         ОПЕРАЦИИ С БАНКОМ:
         ------------------
         Депозиты от проигравших:
         - Григорий: 7,850₽ (полный долг)
         - Дмитрий: 1,800₽ (полный долг)
         - Евгений: 800₽ (полный долг)
         Итого депозитов: 10,450₽

         Withdrawals (частичные выплаты победителям):
         - Алексей: 10,000₽ (частичная выплата)
         - Борис: 5,000₽ (частичная выплата)
         Итого withdrawals: 15,000₽

         Чистый баланс банка: 10,450 - 15,000 = -4,550₽

         ОЖИДАЕМЫЕ РАСЧЁТЫ:
         ------------------

         После учёта операций с банком:

         Creditors (кредиторы, кто должен получить):
         - Алексей: 14,100 - 10,000 (получил) = 4,100₽
         - Борис: 5,850 - 5,000 (получил) = 850₽
         - Виктор: 1,700₽

         Debtors (должники, кто должен отдать):
         - Григорий: 7,850 - 7,850 (внёс) = 0₽ (погасил через банк)
         - Дмитрий: 1,800 - 1,800 (внёс) = 0₽ (погасил через банк)
         - Евгений: 800 - 800 (внёс) = 0₽ (погасил через банк)

         ПЕРЕВОДЫ:
         ---------

         Из банка:
         - Алексей получает 4,100₽
         - Борис получает 850₽
         - Виктор получает 1,700₽
         Итого: 6,650₽

         P2P переводы:
         - Нет (все долги погашены через банк)

         БАЛАНС СИСТЕМЫ:
         --------------
         Банк до settlement: -4,550₽
         Выплачено из банка: 6,650₽
         Остаток в банке: -4,550 - 6,650 = -11,200₽

         НО! В банке зарезервировано:
         - Рейк: 1,000₽
         - Чаевые: 500₽
         - Итого резервов: 1,500₽

         Фактический баланс: -11,200 + 1,500 = -9,700₽

         Плюс нераспределённый рейкбек: 300₽
         Итого: -9,700 + 300 = -9,400₽

         Это покрывается расходами плательщиков и рейкбеком!
         */

        // Given: Комплексная сессия со всеми возможными сценариями
        let session = SessionBuilder()
            .withChipRatio(1)
            .withRake(1000)   // 1,000₽ рейка
            .withTips(500)    // 500₽ чаевых

        // Игроки
            .addPlayer("Алексей", buyIn: 10000, cashOut: 22000)  // +12,000₽
            .addPlayer("Борис", buyIn: 8000, cashOut: 13000)     // +5,000₽
            .addPlayer("Виктор", buyIn: 5000, cashOut: 6500)     // +1,500₽
            .addPlayer("Григорий", buyIn: 12000, cashOut: 5000)  // -7,000₽
            .addPlayer("Дмитрий", buyIn: 7000, cashOut: 6000)    // -1,000₽
            .addPlayer("Евгений", buyIn: 6000, cashOut: 6000)    // 0₽

        // Банк с операциями
            .withBank()

        // Депозиты от проигравших
            .addBankDeposit(player: "Григорий", amount: 7850)
            .addBankDeposit(player: "Дмитрий", amount: 1800)
            .addBankDeposit(player: "Евгений", amount: 800)

        // Частичные выплаты победителям
            .addBankWithdrawal(player: "Алексей", amount: 10000)
            .addBankWithdrawal(player: "Борис", amount: 5000)

        // Рейкбек (700₽ из 1,000₽)
            .addRakebackDistribution(player: "Алексей", amount: 300)
            .addRakebackDistribution(player: "Виктор", amount: 400)

        // Расходы с различными сценариями
            .addExpense(
                amount: 3000,
                note: "Еда",
                payer: "Алексей",
                distributions: [
                    ("Алексей", 500),
                    ("Борис", 500),
                    ("Виктор", 500),
                    ("Григорий", 500),
                    ("Дмитрий", 500),
                    ("Евгений", 500)
                ]
            )
            .addExpense(
                amount: 2000,
                note: "Аренда стола",
                payer: "Борис",
                distributions: [
                    ("Алексей", 400),
                    ("Борис", 350),
                    ("Виктор", 300),
                    ("Григорий", 350),
                    ("Дмитрий", 300),
                    ("Евгений", 300)
                ]
            )
            .addExpense(
                amount: 900,
                note: "Напитки",
                payer: "Виктор",
                distributions: [
                    ("Алексей", 300),
                    ("Борис", 300),
                    ("Виктор", 300)
                ]
            )
            .addExpense(
                amount: 600,
                note: "Чаевые дилеру",
                payer: nil,
                distributions: []  // Не распределен
            )
            .build()

        // When: Рассчитываем settlement
        let result = service.calculate(for: session)

        // DEBUG: Выводим все переводы
        print("\n=== ЭТАЛОННЫЙ ТЕСТ: БАЛАНСЫ ИГРОКОВ ===")
        for balance in result.balances {
            print("\(balance.player.name):")
            print("  Фишки: \(balance.buyIn) → \(balance.cashOut) = \(balance.cashOut - balance.buyIn >= 0 ? "+" : "")\(balance.cashOut - balance.buyIn)")
            print("  Расходы: оплатил \(balance.expensePaid)₽, доля \(balance.expenseShare)₽")
            print("  Рейкбек: \(balance.rakeback)₽")
            print("  Итого: \(balance.netCash >= 0 ? "+" : "")\(balance.netCash)₽")
        }

        print("\n=== ЭТАЛОННЫЙ ТЕСТ: ПЕРЕВОДЫ ИЗ БАНКА (\(result.bankTransfers.count)) ===")
        for transfer in result.bankTransfers {
            print("Банк → \(transfer.to.name): \(transfer.amount)₽")
        }

        print("\n=== ЭТАЛОННЫЙ ТЕСТ: P2P ПЕРЕВОДЫ (\(result.playerTransfers.count)) ===")
        for transfer in result.playerTransfers {
            print("\(transfer.from.name) → \(transfer.to.name): \(transfer.amount)₽")
        }

        // Then: Проверяем балансы с учётом расходов и рейкбека

        // Алексей: +12,000 (фишки) +3,000 (возврат за еду) -1,200 (доля расходов) +300 (рейкбек) = +14,100₽
        assertBalance(result, player: "Алексей", netCash: 14100)
        assertExpensePaid(result, player: "Алексей", amount: 3000)
        assertExpenseShare(result, player: "Алексей", amount: 1200)
        assertRakeback(result, player: "Алексей", amount: 300)

        // Борис: +5,000 (фишки) +2,000 (возврат за аренду) -1,150 (доля расходов) = +5,850₽
        assertBalance(result, player: "Борис", netCash: 5850)
        assertExpensePaid(result, player: "Борис", amount: 2000)
        assertExpenseShare(result, player: "Борис", amount: 1150)
        assertRakeback(result, player: "Борис", amount: 0)

        // Виктор: +1,500 (фишки) +900 (возврат за напитки) -1,100 (доля расходов) +400 (рейкбек) = +1,700₽
        assertBalance(result, player: "Виктор", netCash: 1700)
        assertExpensePaid(result, player: "Виктор", amount: 900)
        assertExpenseShare(result, player: "Виктор", amount: 1100)
        assertRakeback(result, player: "Виктор", amount: 400)

        // Григорий: -7,000 (фишки) -850 (доля расходов) = -7,850₽
        assertBalance(result, player: "Григорий", netCash: -7850)
        assertExpensePaid(result, player: "Григорий", amount: 0)
        assertExpenseShare(result, player: "Григорий", amount: 850)

        // Дмитрий: -1,000 (фишки) -800 (доля расходов) = -1,800₽
        assertBalance(result, player: "Дмитрий", netCash: -1800)
        assertExpensePaid(result, player: "Дмитрий", amount: 0)
        assertExpenseShare(result, player: "Дмитрий", amount: 800)

        // Евгений: 0 (фишки) -800 (доля расходов) = -800₽
        assertBalance(result, player: "Евгений", netCash: -800)
        assertExpensePaid(result, player: "Евгений", amount: 0)
        assertExpenseShare(result, player: "Евгений", amount: 800)

        // Проверяем суммарные показатели
        let totalExpensesPaid = result.balances.reduce(0) { $0 + $1.expensePaid }
        let totalExpensesShared = result.balances.reduce(0) { $0 + $1.expenseShare }
        let totalRakeback = result.balances.reduce(0) { $0 + $1.rakeback }

        #expect(totalExpensesPaid == 5900, "Всего оплачено расходов: 5900₽")
        #expect(totalExpensesShared == 5900, "Всего распределено расходов: 5900₽")
        #expect(totalRakeback == 700, "Всего распределено рейкбека: 700₽")

        // Проверяем баланс системы
        let totalPlayerBalance = result.balances.reduce(0) { $0 + $1.netCash }

        print("\n=== ЭТАЛОННЫЙ ТЕСТ: ИТОГИ ===")
        print("Всего расходов оплачено: \(totalExpensesPaid)₽")
        print("Всего расходов распределено: \(totalExpensesShared)₽")
        print("Распределено рейкбека: \(totalRakeback)₽")
        print("Суммарный баланс игроков: \(totalPlayerBalance)₽")

        // Баланс игроков должен быть положительным из-за рейкбека
        #expect(totalPlayerBalance > 0, "Баланс игроков положительный из-за рейкбека")
    }

    @Test("Реальная сессия: финансовые результаты с банком и рейкбеком")
    func testRealSessionFinancialResults() {
        /*
         РЕАЛЬНАЯ СЕССИЯ С 8 ИГРОКАМИ
         =============================

         Этот тест проверяет расчёты финансовых результатов на реальных данных сессии.

         РЕАЛЬНАЯ СИТУАЦИЯ:
         ------------------
         Игроки сыграли сессию. После игры только Вова Зелик внес свой проигрыш в кассу
         (275,000₽) и оставил деньги "на столе". Из этих ФИЗИЧЕСКИХ денег сразу оплатили
         все расходы и чаевые диллеру (214,000₽). В кассе осталось 61,000₽.

         Игроки договорились, что расходы будут покрыты из рейка (виртуально), а остаток
         рейка распределят как рейкбек между 4 игроками.

         ПАРАМЕТРЫ СЕССИИ:
         -----------------
         Курс: 1 фишка = 1 рубль (1:1)
         Рейк собран: 430,000 фишек → 430,000₽
         Чаевые собраны: 27,000 фишек → 27,000₽
         Всего резервов: 457,000₽

         ФИЗИЧЕСКИЕ ОПЕРАЦИИ С КАССОЙ:
         -----------------------------
         1. Вова Зелик внес: 275,000₽ (депозит)
         2. Оплачены расходы из кассы: 187,000₽
            - Счет: 113,000₽
            - Комната: 35,000₽
            - Дилеры: 39,000₽
         3. Оплачены чаевые диллеру из кассы: 27,000₽
         4. ОСТАТОК В КАССЕ: 275,000₽ - 214,000₽ = 61,000₽

         ВИРТУАЛЬНЫЙ УЧЕТ РЕЗЕРВОВ:
         --------------------------
         Резервы (рейк + чаевые): 457,000₽
         Минус расходы (покрыты из рейка): 187,000₽
         Минус чаевые (покрыты из чаевых): 27,000₽
         ДОСТУПНО НА РЕЙКБЕК: 457,000₽ - 214,000₽ = 243,000₽

         ИГРОКИ И ИХ РЕЗУЛЬТАТЫ:
         -----------------------

         ПОБЕДИТЕЛИ (кому банк должен):

         1. Шота:
            - Buy-in: 350,000 фишек
            - Cash-out: 417,000 фишек
            - Результат по фишкам: +67,000
            - Рейкбек: +60,750₽
            - ИТОГОВЫЙ БАЛАНС: +127,750₽ (банк должен)

         2. Олег:
            - Buy-in: 50,000 фишек
            - Cash-out: 130,000 фишек
            - Результат по фишкам: +80,000
            - Рейкбек: +60,750₽
            - ИТОГОВЫЙ БАЛАНС: +140,750₽ (банк должен)

         3. Юлиан:
            - Buy-in: 50,000 фишек
            - Cash-out: 75,000 фишек
            - Результат по фишкам: +25,000
            - Рейкбек: 0₽
            - ИТОГОВЫЙ БАЛАНС: +25,000₽ (банк должен)

         4. Вова Мария:
            - Buy-in: 200,000 фишек
            - Cash-out: 310,000 фишек
            - Результат по фишкам: +110,000
            - Рейкбек: 0₽
            - ИТОГОВЫЙ БАЛАНС: +110,000₽ (банк должен)

         5. Ян:
            - Buy-in: 250,000 фишек
            - Cash-out: 350,000 фишек
            - Результат по фишкам: +100,000
            - Рейкбек: 0₽
            - ИТОГОВЫЙ БАЛАНС: +100,000₽ (банк должен)

         ИТОГО ПОБЕДИТЕЛЕЙ: 503,500₽

         ПРОИГРАВШИЕ (кто должен банку):

         6. Шоха:
            - Buy-in: 500,000 фишек
            - Cash-out: 136,000 фишек
            - Результат по фишкам: -364,000
            - Рейкбек: +60,750₽
            - Депозит в банк: 0₽ (НЕ вносил)
            - ИТОГОВЫЙ БАЛАНС: -303,250₽ (должен банку)

         7. Гриша:
            - Buy-in: 200,000 фишек
            - Cash-out: 0 фишек
            - Результат по фишкам: -200,000
            - Рейкбек: +60,750₽
            - Депозит в банк: 0₽ (НЕ вносил)
            - ИТОГОВЫЙ БАЛАНС: -139,250₽ (должен банку)

         8. Вова Зелик (ОСОБЫЙ СЛУЧАЙ):
            - Buy-in: 300,000 фишек
            - Cash-out: 25,000 фишек
            - Результат по фишкам: -275,000
            - Рейкбек: 0₽
            - Депозит в банк: 275,000₽ (внес ПОЛНУЮ сумму долга)
            - ИТОГОВЫЙ БАЛАНС: 0₽ (РАСЧИТАЛСЯ)
            - ❗️ НЕ ДОЛЖЕН отображаться ни в "Игроки в плюсе", ни в "Игроки в минусе"

         ИТОГО ПРОИГРАВШИХ: -442,500₽

         РАСПРЕДЕЛЕНИЕ РЕЙКБЕКА:
         -----------------------
         Доступно для рейкбека: 243,000₽

         Распределение поровну между 4 игроками (Шоха, Шота, Гриша, Олег):
         - Каждому: 243,000₽ / 4 = 60,750₽
         - Шоха:  60,750₽
         - Шота:  60,750₽
         - Гриша: 60,750₽
         - Олег:  60,750₽

         ПРОВЕРКА БАЛАНСОВ:
         ------------------
         Сумма всех балансов игроков:
         - Победители (К получению): +503,500₽
         - Проигравшие (К оплате): -442,500₽
         - Итого: +61,000₽

         Этот положительный баланс (+61,000₽) = остаток физических денег в кассе.

         ОЖИДАЕМЫЕ ФИНАНСОВЫЕ РЕЗУЛЬТАТЫ:
         --------------------------------

         1. В ПЛЮСЕ (bank.playersOwedByBank):
            - Шота: 127,750₽
            - Олег: 140,750₽
            - Юлиан: 25,000₽
            - Вова Мария: 110,000₽
            - Ян: 100,000₽
            ИТОГО: 5 игроков

         2. В МИНУСЕ (bank.playersOwingBank):
            - Шоха: 303,250₽
            - Гриша: 139,250₽
            ИТОГО: 2 игрока

         3. НЕ ОТОБРАЖАЕТСЯ:
            - Вова Зелик: 0₽ (расчитался через банк)

         БАЛАНС БАНКА (ТЕКУЩЕЕ СОСТОЯНИЕ - НЕКОРРЕКТНОЕ):
         ------------------------------------------------
         ⚠️ ПРОБЛЕМА: Settlement не учитывает физические траты из кассы!

         Депозиты: 275,000₽ (от Вовы Зелика)
         Выдано (расходы + чаевые): 214,000₽
         Net balance (правильный): 61,000₽

         НО! Settlement видит:
         - contributions(for: Вова) = 275,000₽ - 0₽ = 275,000₽
         - Потому что транзакции расходов/чаевых имеют player: nil
         - И не учитываются в netContribution конкретных игроков!

         Результат: Settlement пытается выдать из кассы 275,000₽ вместо 61,000₽

         Зарезервировано (виртуально):
         - Рейк: 430,000₽
         - Чаевые: 27,000₽
         - Итого: 457,000₽

         Использовано из резервов:
         - Расходы: 187,000₽
         - Чаевые: 27,000₽
         - Рейкбек: 243,000₽
         - Итого: 457,000₽

         Организационный сбор (остаток): 0₽ (весь рейк распределён)
         */

        // Given: Реальная сессия с 8 игроками
        let session = SessionBuilder()
            .withChipRatio(1)  // 1 фишка = 1 рубль
            .withRake(430_000)  // 431,000 фишек рейка
            .withTips(27_000)   // 27,000 фишек чаевых

        // Добавляем всех игроков
            .addPlayer("Шота", buyIn: 350_000, cashOut: 417_000)      // +67,000 + рейкбек
            .addPlayer("Шоха", buyIn: 500_000, cashOut: 136_000)      // -364,000 + рейкбек
            .addPlayer("Олег", buyIn: 50_000, cashOut: 130_000)       // +80,000 + рейкбек
            .addPlayer("Гриша", buyIn: 200_000, cashOut: 0)           // -200,000 + рейкбек
            .addPlayer("Юлиан", buyIn: 50_000, cashOut: 75_000)       // +25,000
            .addPlayer("Вова Зелик", buyIn: 300_000, cashOut: 25_000) // -275,000 (внесет в банк)
            .addPlayer("Вова Мария", buyIn: 200_000, cashOut: 310_000)// +110,000
            .addPlayer("Ян", buyIn: 250_000, cashOut: 350_000)        // +100,000

        // Создаём банк
            .withBank()

        // Вова Зелик вносит полную сумму долга в банк
            .addBankDeposit(player: "Вова Зелик", amount: 275_000)

        // Распределяем рейкбек поровну между 4 игроками
        // Доступно: 457,000 - 214,000 = 243,000₽
        // Каждому: 60,750₽
            .addRakebackDistribution(player: "Шоха", amount: 60_750)
            .addRakebackDistribution(player: "Шота", amount: 60_750)
            .addRakebackDistribution(player: "Гриша", amount: 60_750)
            .addRakebackDistribution(player: "Олег", amount: 60_750)

        // Добавляем расходы и оплачиваем их ФИЗИЧЕСКИ из кассы
        // но помечаем как "покрытые из рейка" (виртуально)
            .addExpenseFromRake(amount: 113_000, note: "Счет")
            .addExpenseFromRake(amount: 35_000, note: "Комната")
            .addExpenseFromRake(amount: 39_000, note: "Дилеры")
            .payExpenseFromBank(expenseNote: "Счет", amount: 113_000)      // Физическая оплата
            .payExpenseFromBank(expenseNote: "Комната", amount: 35_000)   // Физическая оплата
            .payExpenseFromBank(expenseNote: "Дилеры", amount: 39_000)    // Физическая оплата

        // Оплачиваем чаевые ФИЗИЧЕСКИ из кассы
            .payTipsFromBank(amount: 27_000)

            .build()

        guard let bank = session.bank else {
            Issue.record("Банк сессии не найден")
            return
        }

        // When: Рассчитываем settlement
        let result = service.calculate(for: session)

        // Then: Проверяем игроков в плюсе (банк должен им)
        let playersInProfit = bank.playersOwedByBank
        let profitAmounts = playersInProfit.map { (player: $0, amount: max(bank.financialResult(for: $0), 0)) }

        print("\n=== РЕАЛЬНАЯ СЕССИЯ: ИГРОКИ В ПЛЮСЕ ===")
        for (player, amount) in profitAmounts {
            print("\(player.name): +\(amount.asCurrency())")
        }

        #expect(playersInProfit.count == 5, "Должно быть 5 игроков в плюсе")

        // Проверяем суммы для каждого игрока в плюсе
        assertPlayerOwedByBank(bank, player: "Шота", expectedAmount: 127_750)
        assertPlayerOwedByBank(bank, player: "Олег", expectedAmount: 140_750)
        assertPlayerOwedByBank(bank, player: "Юлиан", expectedAmount: 25_000)
        assertPlayerOwedByBank(bank, player: "Вова Мария", expectedAmount: 110_000)
        assertPlayerOwedByBank(bank, player: "Ян", expectedAmount: 100_000)

        // Проверяем игроков в минусе (они должны банку)
        let playersInLoss = bank.playersOwingBank
        let lossAmounts = playersInLoss.map { (player: $0, amount: max(-bank.financialResult(for: $0), 0)) }

        print("\n=== РЕАЛЬНАЯ СЕССИЯ: ИГРОКИ В МИНУСЕ ===")
        for (player, amount) in lossAmounts {
            print("\(player.name): -\(amount.asCurrency())")
        }

        #expect(playersInLoss.count == 2, "Должно быть 2 игрока в минусе")

        // Проверяем суммы для каждого игрока в минусе
        assertPlayerOwingBank(bank, player: "Шоха", expectedAmount: 303_250)
        assertPlayerOwingBank(bank, player: "Гриша", expectedAmount: 139_250)

        // Проверяем, что Вова Зелик НЕ отображается ни в одном списке
        print("\n=== РЕАЛЬНАЯ СЕССИЯ: ПРОВЕРКА РАСЧИТАВШИХСЯ ===")
        let vovaZelik = session.players.first { $0.name == "Вова Зелик" }!
        let vovaResult = bank.financialResult(for: vovaZelik)
        let vovaOwedByBank = max(vovaResult, 0)
        let vovaOwingBank = max(-vovaResult, 0)

        print("Вова Зелик:")
        print("  - Банк должен ему: \(vovaOwedByBank)₽")
        print("  - Он должен банку: \(vovaOwingBank)₽")
        print("  - В списке 'в плюсе': \(playersInProfit.contains(where: { $0.id == vovaZelik.id }) ? "ДА" : "НЕТ")")
        print("  - В списке 'в минусе': \(playersInLoss.contains(where: { $0.id == vovaZelik.id }) ? "ДА" : "НЕТ")")

        #expect(vovaOwedByBank == 0, "Банк НЕ должен Вове Зелику (он расчитался)")
        #expect(vovaOwingBank == 0, "Вова Зелик НЕ должен банку (он внёс полную сумму)")
        #expect(!playersInProfit.contains(where: { $0.id == vovaZelik.id }), "Вова Зелик НЕ должен быть в списке 'в плюсе'")
        #expect(!playersInLoss.contains(where: { $0.id == vovaZelik.id }), "Вова Зелик НЕ должен быть в списке 'в минусе'")

        // Проверяем суммы
        let totalProfit = profitAmounts.reduce(0) { $0 + $1.amount }
        let totalLoss = lossAmounts.reduce(0) { $0 + $1.amount }

        print("\n=== РЕАЛЬНАЯ СЕССИЯ: ИТОГИ ===")
        print("Всего в плюсе: \(totalProfit.asCurrency())")
        print("Всего в минусе: \(totalLoss.asCurrency())")
        print("Разница: \((totalProfit - totalLoss).asCurrency())")

        #expect(totalProfit == 503_500, "Общая сумма в плюсе должна быть 503,500₽")
        #expect(totalLoss == 442_500, "Общая сумма в минусе должна быть 442,500₽")

        // Проверяем баланс банка
        print("\n=== РЕАЛЬНАЯ СЕССИЯ: БАЛАНС БАНКА ===")
        print("Депозиты: \(bank.totalDeposited.asCurrency())")
        print("Withdrawals: \(bank.totalWithdrawn.asCurrency())")
        print("Net balance: \(bank.netBalance.asCurrency())")
        print("Зарезервировано (рейк): \(bank.reservedForRake.asCurrency())")
        print("Зарезервировано (чаевые): \(bank.reservedForTips.asCurrency())")
        print("Всего зарезервировано: \(bank.totalReserved.asCurrency())")
        print("Расходы из рейка: \(bank.totalExpensesPaidFromRake.asCurrency())")
        print("Организационный сбор: \(bank.organizationalFee.asCurrency())")

        // Проверяем баланс кассы
        #expect(bank.totalDeposited == 275_000, "Депозиты = 275,000₽ (от Вовы Зелика)")
        #expect(bank.totalWithdrawn == 214_000, "Выдано = 214,000₽ (187k расходы + 27k чаевые)")
        #expect(bank.netBalance == 61_000, "Net balance = 61,000₽ (275k - 214k)")

        // Проверяем резервы
        #expect(bank.reservedForRake == 430_000, "Зарезервировано рейка: 430,000₽")
        #expect(bank.reservedForTips == 27_000, "Зарезервировано чаевых: 27,000₽")
        #expect(bank.totalReserved == 457_000, "Всего резервов: 457,000₽")

        // Проверяем использование резервов
        #expect(bank.totalExpensesPaidFromRake == 187_000, "Расходы покрыты из рейка: 187,000₽")

        // Распределенный рейкбек
        let distributedRakeback = session.players.filter { $0.getsRakeback }.reduce(0) { $0 + $1.rakeback }
        print("Распределенный рейкбек: \(distributedRakeback.asCurrency())")
        #expect(distributedRakeback == 243_000, "Распределено рейкбека: 243,000₽")

        // Организационный сбор должен быть 0 (весь рейк ушел на расходы и рейкбек)
        #expect(bank.organizationalFee == 0, "Организационный сбор = 0₽ (весь рейк распределён)")

        // ПРОВЕРКА SETTLEMENT АЛГОРИТМА
        // =============================

        print("\n=== РЕАЛЬНАЯ СЕССИЯ: SETTLEMENT БАЛАНСЫ ===")
        for balance in result.balances {
            let netChips = balance.cashOut - balance.buyIn
            print("\(balance.player.name): закуп=\(balance.buyIn), вывод=\(balance.cashOut), " +
                  "фишки=\(netChips >= 0 ? "+" : "")\(netChips), " +
                  "рейкбек=\(balance.rakeback)₽, " +
                  "итого=\(balance.netCash >= 0 ? "+" : "")\(balance.netCash)₽")
        }

        // Проверяем балансы игроков через SettlementResult
        assertBalance(result, player: "Шота", netCash: 127_750)     // +67,000 + 60,750 рейкбек
        assertBalance(result, player: "Олег", netCash: 140_750)     // +80,000 + 60,750 рейкбек
        assertBalance(result, player: "Юлиан", netCash: 25_000)     // +25,000
        assertBalance(result, player: "Вова Мария", netCash: 110_000) // +110,000
        assertBalance(result, player: "Ян", netCash: 100_000)       // +100,000
        assertBalance(result, player: "Шоха", netCash: -303_250)    // -364,000 + 60,750 рейкбек
        assertBalance(result, player: "Гриша", netCash: -139_250)   // -200,000 + 60,750 рейкбек
        assertBalance(result, player: "Вова Зелик", netCash: -275_000) // -275,000

        // Проверяем рейкбек у игроков
        assertRakeback(result, player: "Шоха", amount: 60_750)
        assertRakeback(result, player: "Шота", amount: 60_750)
        assertRakeback(result, player: "Гриша", amount: 60_750)
        assertRakeback(result, player: "Олег", amount: 60_750)
        assertRakeback(result, player: "Юлиан", amount: 0)
        assertRakeback(result, player: "Вова Зелик", amount: 0)
        assertRakeback(result, player: "Вова Мария", amount: 0)
        assertRakeback(result, player: "Ян", amount: 0)

        // Проверяем переводы
        print("\n=== РЕАЛЬНАЯ СЕССИЯ: ПЕРЕВОДЫ ИЗ БАНКА (\(result.bankTransfers.count)) ===")
        for transfer in result.bankTransfers {
            print("Банк → \(transfer.to.name): \(transfer.amount)₽")
        }

        print("\n=== РЕАЛЬНАЯ СЕССИЯ: ПРЯМЫЕ ПЕРЕВОДЫ (\(result.playerTransfers.count)) ===")
        for transfer in result.playerTransfers {
            print("\(transfer.from.name) → \(transfer.to.name): \(transfer.amount)₽")
        }

        // Проверяем, что есть переводы (конкретные проверки зависят от алгоритма settlement)
        // Минимум проверяем что алгоритм сработал и создал переводы
        let totalBankTransfers = result.bankTransfers.reduce(0) { $0 + $1.amount }
        let totalPlayerTransfers = result.playerTransfers.reduce(0) { $0 + $1.amount }

        print("\n=== РЕАЛЬНАЯ СЕССИЯ: ИТОГИ ПЕРЕВОДОВ ===")
        print("Всего переводов из банка: \(totalBankTransfers.asCurrency())")
        print("Всего прямых переводов: \(totalPlayerTransfers.asCurrency())")
        print("Общая сумма переводов: \((totalBankTransfers + totalPlayerTransfers).asCurrency())")
        print(bank.netBalance)
        print(bank.totalReserved)

        // Общая сумма переводов должна равняться сумме всех выплат победителям
        // (банк должен выдать 503,500₽, из них 275,000₽ есть в банке от Вовы Зелика)
        let expectedTotalTransfers = totalProfit
        let actualTotalTransfers = totalBankTransfers + totalPlayerTransfers

        print("Ожидаемая сумма переводов: \(expectedTotalTransfers.asCurrency())")
        print("Фактическая сумма переводов: \(actualTotalTransfers.asCurrency())")

        #expect(actualTotalTransfers == expectedTotalTransfers,
                "Общая сумма переводов (\(actualTotalTransfers)₽) должна равняться общей сумме в плюсе (\(expectedTotalTransfers)₽)")
    }
}
