# Анализ Cash Flow в системе Home Poker

## Кейс: Реальная сессия с Вовой Зеликом

### Исходные данные

**Игроки и их результаты:**
```
Шота:       buyIn: 350k, cashOut: 417k  → profit: +67k  + rakeback: 60.75k = +127.75k
Шоха:       buyIn: 500k, cashOut: 136k  → profit: -364k + rakeback: 60.75k = -303.25k
Олег:       buyIn: 50k,  cashOut: 130k  → profit: +80k  + rakeback: 60.75k = +140.75k
Гриша:      buyIn: 200k, cashOut: 0k    → profit: -200k + rakeback: 60.75k = -139.25k
Юлиан:      buyIn: 50k,  cashOut: 75k   → profit: +25k  + rakeback: 0k     = +25k
Вова Зелик: buyIn: 300k, cashOut: 25k   → profit: -275k + rakeback: 0k     = -275k
Вова Мария: buyIn: 200k, cashOut: 310k  → profit: +110k + rakeback: 0k     = +110k
Ян:         buyIn: 250k, cashOut: 350k  → profit: +100k + rakeback: 0k     = +100k
```

**Резервы:**
```
Рейк:   430,000₽
Чаевые:  27,000₽
─────────────────
ИТОГО:  457,000₽
```

**Распределение резервов:**
```
Рейкбек: 243,000₽ (4 игрока × 60,750₽)
Расходы: 187,000₽ (из рейка)
Чаевые:   27,000₽ (из резерва чаевых)
─────────────────
ИТОГО:  457,000₽ ✅
```

**Банк:**
```
Вова Зелик внес: 275,000₽
```

**Расходы (оплачены из банка, покрыты из резервов):**
```
Счет:    113,000₽ (paidFromBank: 113k, paidFromRake: 113k)
Комната:  35,000₽ (paidFromBank: 35k,  paidFromRake: 35k)
Дилеры:   39,000₽ (paidFromBank: 39k,  paidFromRake: 39k)
Чаевые:   27,000₽ (paidFromBank: 27k,  reservedForTips: 27k)
─────────────────────
ИТОГО:   214,000₽
```

---

## Cash Flow Analysis

### 1. CHIP ECONOMY (фишки на столе)

```
┌─────────────────────────────────────────────────┐
│  ФИШКИ НА СТОЛЕ                                 │
│                                                 │
│  Buy-ins (деньги → фишки):                      │
│  ├─ Шота:  350,000                              │
│  ├─ Шоха:  500,000                              │
│  ├─ Олег:   50,000                              │
│  ├─ Гриша: 200,000                              │
│  ├─ Юлиан:  50,000                              │
│  ├─ Вова З: 300,000                             │
│  ├─ Вова М: 200,000                             │
│  └─ Ян:    250,000                              │
│  ═══════════════════                            │
│  ИТОГО:  1,900,000 фишек                        │
│                                                 │
│  Cash-outs (фишки → деньги):                    │
│  ├─ Шота:  417,000                              │
│  ├─ Шоха:  136,000                              │
│  ├─ Олег:  130,000                              │
│  ├─ Гриша:      0                               │
│  ├─ Юлиан:  75,000                              │
│  ├─ Вова З:  25,000                             │
│  ├─ Вова М: 310,000                             │
│  └─ Ян:    350,000                              │
│  ═══════════════════                            │
│  ИТОГО:  1,443,000 фишек                        │
│                                                 │
│  ОСТАТОК НА СТОЛЕ:                              │
│  1,900,000 - 1,443,000 = 457,000 фишек          │
│  (это рейк + чаевые)                            │
└─────────────────────────────────────────────────┘
```

**Проверка баланса фишек:** ✅
```
Buy-ins = Cash-outs + Rake + Tips
1,900,000 = 1,443,000 + 430,000 + 27,000 ✅
```

---

### 2. MONEY ECONOMY (реальные деньги)

#### 2.1 Физический баланс игроков (до взносов в банк)

```
┌─────────────────────────────────────────────────┐
│  ДЕНЬГИ У ИГРОКОВ (после игры, до settlement)   │
│                                                 │
│  Игроки В ПЛЮСЕ (должны получить):              │
│  ├─ Шота:       +127,750₽ (67k + 60.75k)        │
│  ├─ Олег:       +140,750₽ (80k + 60.75k)        │
│  ├─ Юлиан:       +25,000₽                       │
│  ├─ Вова Мария: +110,000₽                       │
│  └─ Ян:         +100,000₽                       │
│  ═════════════════════════                      │
│  ИТОГО:        +503,500₽                        │
│                                                 │
│  Игроки В МИНУСЕ (должны заплатить):            │
│  ├─ Шоха:      -303,250₽ (-364k + 60.75k)       │
│  ├─ Гриша:     -139,250₽ (-200k + 60.75k)       │
│  └─ Вова Зелик: -275,000₽                       │
│  ═════════════════════════                      │
│  ИТОГО:        -717,500₽                        │
│                                                 │
│  ДИСБАЛАНС:                                     │
│  503,500 - 717,500 = -214,000₽                  │
│  (это расходы, которые надо покрыть)            │
└─────────────────────────────────────────────────┘
```

**⚠️ ПРОБЛЕМА:** Минус 214,000₽ - откуда взять эти деньги?

**ОТВЕТ:** Из резервов! (рейк - рейкбек - расходы = 0)

---

#### 2.2 Резервы и их использование

```
┌─────────────────────────────────────────────────┐
│  РЕЗЕРВЫ (виртуальные деньги)                   │
│                                                 │
│  Источник:                                      │
│  └─ Остаток фишек на столе: 457,000 фишек       │
│     (ratio 1:1) = 457,000₽                      │
│                                                 │
│  Распределение:                                 │
│  ├─ Рейкбек игрокам:  243,000₽                  │
│  ├─ Расходы:          187,000₽                  │
│  ├─ Чаевые:            27,000₽                  │
│  ═════════════════════════════                  │
│  ИТОГО:              457,000₽ ✅                │
│                                                 │
│  Организационный сбор:                          │
│  430,000 - 243,000 - 187,000 = 0₽               │
└─────────────────────────────────────────────────┘
```

**Ключевой момент:** Резервы уже РАСПРЕДЕЛЕНЫ:
- 243k → игрокам (уже учтено в их балансах)
- 214k → на покрытие расходов и чаевых

---

#### 2.3 Банк (физические деньги)

```
┌─────────────────────────────────────────────────┐
│  БАНК (реальные деньги в кассе)                 │
│                                                 │
│  Взносы:                                        │
│  └─ Вова Зелик: +275,000₽                       │
│                                                 │
│  Расходы (физически из кассы):                  │
│  ├─ Счет:    -113,000₽                          │
│  ├─ Комната:  -35,000₽                          │
│  ├─ Дилеры:   -39,000₽                          │
│  └─ Чаевые:   -27,000₽                          │
│  ═════════════════════════                      │
│  Потрачено:  -214,000₽                          │
│                                                 │
│  ФИЗИЧЕСКИ В БАНКЕ:                             │
│  275,000 - 214,000 = 61,000₽                    │
│                                                 │
│  НО! Эти расходы покрыты резервами:             │
│  └─ Виртуальный возврат: +214,000₽              │
│                                                 │
│  ДОСТУПНО ДЛЯ РАЗДАЧИ:                          │
│  61,000₽ (физически) + 214,000₽ (виртуально)   │
│  = 275,000₽                                     │
└─────────────────────────────────────────────────┘
```

**⚠️ ВОТ ПРОБЛЕМА!**

---

## ПРОБЛЕМА В ЛОГИКЕ

### Текущая ситуация:

1. **Вова Зелик:**
   ```
   Покерный результат: -275,000₽
   Внес в банк: +275,000₽
   ─────────────────────────────
   Баланс: 0₽ ✅ (расчитался)
   ```

2. **Расходы 214k:**
   ```
   Оплачены из БАНКА (из денег Вовы): -214,000₽
   Покрыты из РЕЗЕРВОВ (рейк+чаевые): +214,000₽
   ─────────────────────────────
   Чистый эффект на банк: 0₽
   ```

3. **НО в системе:**
   ```
   contributions(for: Вова):
   - deposited: 275,000₽
   - withdrawn: 214,000₽ (наша корректировка)
   - netContribution: 61,000₽

   coveredExpensesShare(for: Вова): 214,000₽

   financialResult:
   = -275,000 (покер) + 61,000 (netContrib) + 214,000 (covered)
   = 0₽ ✅
   ```

### Проблема в Settlement:

Settlement использует `netContribution` для распределения денег из банка:

```
playerDeposits = [Вова: 61,000₽]  ← ТОЛЬКО 61k!

Победители нуждаются в: 503,500₽
Из банка доступно: 61,000₽
Недостаток: 442,500₽ ← проигравшие должны прямыми переводами
```

**НО ПРАВИЛЬНО ДОЛЖНО БЫТЬ:**

Резервы (214k) уже ИСПОЛЬЗОВАНЫ для покрытия расходов.
Эти деньги ВИРТУАЛЬНЫЕ и НЕ ДОСТУПНЫ для раздачи победителям!

---

## ПРАВИЛЬНАЯ МОДЕЛЬ

### Концептуально есть ДВА потока денег:

#### 1. РЕАЛЬНЫЕ ДЕНЬГИ (физический кэш-флоу)
```
Вова внес → 275k в банк
Из банка → 214k на расходы (физически ушли)
В банке осталось → 61k (доступно для раздачи)
```

#### 2. ВИРТУАЛЬНЫЕ ДЕНЬГИ (резервы)
```
Рейк собран → 430k (виртуально)
Рейкбек → 243k (виртуально раздали игрокам)
Расходы → 187k (виртуально покрыли)
Чаевые → 27k (виртуально покрыли)
Оргсбор → 0k
```

### КЛЮЧЕВОЙ ИНСАЙТ:

**Резервы НЕ МОГУТ быть использованы для раздачи победителям!**

Когда мы говорим "расходы покрыты из рейка", это значит:
- Организаторы НЕ получают прибыль (оргсбор = 0)
- НО это НЕ значит, что деньги материализовались в банке!

---

## РЕШЕНИЕ

### Вова Зелик должен быть:
```
financialResult = -275,000 + 275,000 = 0₽ ✅
```

### Но для Settlement:
```
В банке физически: 61,000₽
Доступно для раздачи: 61,000₽ (НЕ 275k!)

Победители получают:
- Из банка: 61,000₽
- Прямыми переводами: 442,500₽ (от проигравших)
```

### Текущая проблема в коде:

`coveredExpensesShare` добавляет 214k к `financialResult` Вовы,
делая его баланс 0₽ - ЭТО ПРАВИЛЬНО!

НО Settlement видит `netContribution = 61k` и пытается раздать только 61k из банка.
Остальные 214k ПОТЕРЯНЫ из расчетов!

---

## ЧТО НУЖНО ИСПРАВИТЬ

### Вариант А: Убрать `coveredExpensesShare`

Вова должен:
```
financialResult = -275,000 + 61,000 = -214,000₽
```

Он должен заплатить 214k прямыми переводами.
НО концептуально это неправильно - расходы покрыты резервами!

### Вариант Б: Скорректировать балансы с учетом резервов

Когда расходы покрываются из резервов, УМЕНЬШИТЬ балансы всех игроков на их долю:

```
Шоха:  -303,250 - 26,750 (доля в расходах) = -330,000₽
Гриша: -139,250 - 26,750 (доля в расходах) = -166,000₽
...
```

Тогда:
```
Победители: 503,500 - 214,000 = 289,500₽ (скорректировано)
Проигравшие: 717,500 - 214,000 = 503,500₽ (скорректировано)
Баланс: ОК!
```

### Вариант В: Правильное понимание резервов

**РЕЗЕРВЫ УЖЕ РАСПРЕДЕЛЕНЫ!**

Рейкбек (243k) УЖЕ ДОБАВЛЕН к балансам игроков.
Расходы (214k) ДОЛЖНЫ быть ВЫЧТЕНЫ из балансов.

Если расходы НЕ распределены между игроками (`distributions = []`),
значит их НЕСЁТ ОРГАНИЗАТОР (из оргсбора).

НО оргсбор = 0₽! Значит дефицит!

---

## МОЙ ВОПРОС К ТЕБЕ:

**Кто концептуально несет эти 214,000₽ расходов?**

A. Организаторы (из их прибыли) → тогда оргсбор = -214k
B. Все игроки поровну → создать distributions
C. Вкладчики банка → что мы сейчас пытаемся сделать
D. Другое?
