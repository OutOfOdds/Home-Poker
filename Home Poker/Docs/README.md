# Home Poker

Приложение для управления домашними покерными турнирами на iOS.

## Описание

**Home Poker** - это комплексное приложение для организации и ведения домашних покерных сессий с полным контролем финансов, таймером турнира и автоматическими расчетами между игроками.

### Основные возможности

#### Управление сессиями
- Создание покерных сессий с настройкой параметров (место, тип игры, блайнды)
- Добавление и управление игроками
- Отслеживание buy-in, add-on, rebuy и cash-out
- Учет расходов на еду, напитки и аренду
- Редактирование блайндов в процессе игры

#### Банк сессии
- Централизованное управление денежными потоками
- Регистрация депозитов и выплат игрокам
- Автоматический расчет долгов между банком и игроками
- Отслеживание баланса банка в реальном времени
- Назначение ответственного за банк

#### Таймер турнира
- 9 встроенных шаблонов турниров (Турбо, Стандарт, Глубокий стек)
- Настраиваемая структура блайндов
- Автоматический переход между уровнями
- Пауза и возобновление таймера
- Переход к любому уровню вручную
- Создание и редактирование пользовательских шаблонов

#### Расчеты между игроками (Settlement)
- Автоматический расчет балансов всех игроков
- Жадный алгоритм минимизации количества переводов
- Конвертация результатов из фишек в деньги
- Наглядное отображение кто кому должен

## Технологии

- **Язык**: Swift 5.9+
- **UI Framework**: SwiftUI
- **Архитектура**: MVVM + Clean Architecture
- **Хранилище**: SwiftData
- **Минимальная версия iOS**: 17.0+

## Структура проекта

```
Home Poker/
├── Domain/                    # Бизнес-логика
│   ├── Models/               # Модели данных (SwiftData)
│   ├── Services/             # Сервисы бизнес-логики
│   └── Repositories/         # Репозитории для доступа к данным
├── Features/                 # Фичи приложения
│   ├── SessionList/          # Список сессий
│   ├── Session/              # Детали сессии, банк
│   ├── TimerManager/         # Таймер турнира
│   ├── Settlement/           # Расчеты между игроками
│   └── Settings/             # Настройки приложения
└── Shared/                   # Переиспользуемые компоненты
    ├── Components/           # UI компоненты
    ├── Extensions/           # Расширения
    └── Utilities/            # Утилиты
```

## Документация

Подробная документация проекта находится в папке [Home Poker/Docs](Home Poker/Docs/):

- [architecture-flow.md](Home Poker/Docs/architecture-flow.md) - Архитектура приложения, flow навигации, схема базы данных
- [calculations-flow.md](Home Poker/Docs/calculations-flow.md) - Документация по расчетам, экономикам (фишки vs деньги), алгоритмам

## Архитектура

### Паттерны

1. **MVVM (Model-View-ViewModel)**
   - Разделение UI логики от бизнес-логики
   - Использование `@Observable` для реактивного состояния

2. **Clean Architecture**
   - Слой Domain: модели, сервисы, репозитории
   - Слой Features: UI и ViewModels
   - Слой Shared: переиспользуемые компоненты

3. **Repository Pattern**
   - Абстракция доступа к данным
   - Централизованное управление CRUD операциями

4. **Service Layer**
   - Инкапсуляция бизнес-логики
   - Протоколы для тестируемости и моков

### Модели данных

Основные модели с использованием SwiftData:

- **Session** - покерная сессия
- **Player** - игрок в сессии
- **PlayerTransaction** - транзакция игрока (buy-in, add-on, cash-out)
- **SessionBank** - банк сессии
- **SessionBankTransaction** - транзакция банка (deposit, withdrawal)
- **Expense** - расход сессии
- **TournamentTemplate** - шаблон турнира (Codable, хранится в UserDefaults)
- **BlindLevel** - уровень блайндов

## Установка и запуск

### Требования

- macOS 14.0+ с Xcode 15.0+
- iOS 17.0+ (для запуска на устройстве)

### Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd Home-Poker
```

2. Откройте проект в Xcode:
```bash
open "Home Poker.xcodeproj"
```

3. Выберите целевое устройство (симулятор или физическое устройство)

4. Нажмите Cmd+R для запуска

## Основные сервисы

### SessionService

Управление сессией, игроками, банком и расходами:
- `addPlayer(to:name:buyIn:)` - добавить игрока
- `cashOut(player:amount:)` - завершить игру игрока
- `recordBankTransaction(...)` - записать операцию банка
- `removeBankTransaction(...)` - удалить транзакцию банка
- `closeBank(for:)` / `reopenBank(for:)` - закрыть/открыть банк

### SettlementService

Расчет оптимальных переводов между игроками:
- `calculate(for:) -> SettlementResult` - рассчитать балансы и переводы
- Использует жадный алгоритм для минимизации количества операций

### SessionTimerService

Логика таймера турнира:
- `calculateCurrentLevel(...)` - определить текущий уровень
- `calculateLevelStartTime(...)` - время начала уровня
- `durationInSeconds(for:)` - длительность уровня

### TemplateService

Управление шаблонами турниров:
- `getBuiltInTemplates()` - получить встроенные шаблоны
- `loadUserTemplates()` - загрузить пользовательские шаблоны
- `saveTemplate(_:)` - сохранить шаблон
- `deleteTemplate(id:)` - удалить шаблон

## Особенности реализации

### Две экономики: фишки и деньги

В приложении существуют две параллельные экономики:

1. **Chip Economy (Фишки)** - виртуальная игровая валюта
   - Все игровые операции: buy-in, rebuy, add-on, cash-out
   - Результаты игроков рассчитываются в фишках

2. **Cash Economy (Деньги)** - реальные деньги
   - Операции с реальными деньгами: депозиты, выплаты
   - Расходы на еду, напитки
   - Переводы между игроками

Конвертация между экономиками происходит через параметр `chipsToCashRatio`.

### Cascade Delete Rules

SwiftData модели настроены с правильными правилами удаления:
- Session → Players, SessionBank, Expenses (cascade)
- Player → PlayerTransactions (cascade)
- SessionBank → SessionBankTransactions (cascade)
- Связи с Player в транзакциях и расходах (nullify)

### Удаление транзакций

Реализована логика удаления транзакций с автоматическим восстановлением состояния:
- Удаление cash-out может вернуть игрока в игру
- Удаление транзакции банка пересчитывает expectedTotal
- Все удаления доступны через swipe действия в UI

## Последние изменения

### Октябрь 2025

- ✅ Добавлено удаление транзакций банка по свайпу
- ✅ Упрощена архитектура редактирования шаблонов (локальное состояние)
- ✅ Новый алгоритм генерации блайндов
- ✅ Улучшена форма настройки турнира
- ✅ Реализована логика восстановления статуса игрока при удалении транзакций

## TODO

- [ ] Реализовать полное сохранение пользовательских шаблонов в UserDefaults
- [ ] Добавить экспорт/импорт шаблонов
- [ ] Реализовать VersionedSchema для миграций БД
- [ ] Добавить централизованную обработку ошибок
- [ ] Покрыть сервисы Unit-тестами
- [ ] Добавить логирование критичных операций

## Лицензия

[Указать лицензию проекта]

## Контакты

[Указать контактную информацию]

---

**Последнее обновление**: 30 октября 2025
